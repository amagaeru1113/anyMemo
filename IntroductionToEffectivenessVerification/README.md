# 効果検証入門メモ

サンプルコード
https://github.com/ghmagazine/cibook/

# 効果検証入門

<details>
<summary>memo</summary>

## 1章：セレクションバイアスとRCT
- 効果：施策（介入、処置）以外の要因が同一となった状況での比較によって知り得た施策の影響度合い
- RCT(ABテスト含む)：グループの平均的な性質が同質なグループを介入の有無で分け、これらに施策が与えた影響を比較する試験
- 母集団：潜在的に観測し得る全てのデータを含む集団。
- 標本集団：母集団からいくらかの標本を抽出してなる集団
- 推定：標本集団から母集団の性質を推測すること

#### ポテンシャルアウトカムフレームワーク
ユーザーを$i$、介入の有無を01とし、$Z_{i}$で表す。つまりはユーザー1に介入する場合$Z_{1}=1$。
このユーザの売り上げを$Y_{i}$で表す。つまりはユーザー1に介入があった場合$Y_{i}^{(1)}(Z_{i}=1)$。
これは介入の有無でとる値が二値なので以下のように一つの式に整理できる。

$$
Y_{i} = Y_{i}^{(0)}(1-Z_{i}) + Y_{i}^{(1)}Z_{i}
$$

この単一のサンプル$i$に介入が行われた場合の売り上げと行われなかった場合の売り上げの差に介入の本当の効果があると考えることをポテンシャルアウトカムフレームワークという。ポテンシャルアウトカムとはつまりは反実仮想のことをさす。AとBの選択肢があるとき、私はAを選択してなんらかの結果を得た。この時のポテンシャルアウトカムはBを選択した時の結果のことをさす。売り上げならば介入した時の結果が$Y_{i}^{(1)}$ならば、ポテンシャルアウトカムは$Y_{i}^{(0)}$である。

介入の効果を表す値を$\tau$とすると、ユーザーiへの効果の度合いを売り上げの差分の形で表せる

$$
\tau_{i} = Y_{i}^{(1)} - Y_{i}^{(0)} 
$$

しかし実際にはこの計算式のどちらか一方の結果（売り上げ）しか常に手に入れられない。分かるのはユーザー$i$への介入の有無とその結果のみであって、ポテンシャルアウトカムは得られない。つまりはある個人に関する比較はできないことになる。

そこで、次に考えるのはユーザーのグループである。介入の有無でグループを作り、これらを比較することで「平均的な」効果を測る。
これは売り上げの期待値を比較し、差を得ることである。

$$
\tau = E[Y_{(1)}] - E[Y_{(0)}]
$$

E[]は期待値を表し、母集団における平均を表している。つまりは興味のある介入の効果とは、母集団に置いて介入の有無ぞれぞれの場合の売り上げの平均の差である。このような効果は母集団の平均的な効果を示し、平均処置効果（Average treatment Effect: ATE）と呼ばれる。

上記式を変形すると、介入がなかった場合の売り上げに平均処置効果の補正項を加えることで介入があった場合の売り上げを求める式に改変できる。

$$
E[Y_{(1)}]  =  E[Y_{(0)}] + \tau
$$

#### 平均的な効果の比較
実験をせず（ランダム化せず）に担当者が選んだユーザーグループに介入の有無を割り振る場合、最も簡単な効果の推定はk区グループのユーザー売り上げの平均を差分をとることである。ここでの効果の推定値を$\hat{\tau}_{naive}$と表す。分析するデータのサンプルサイズをNとすると、

$$
\hat{\tau}_{naive} = \frac{1}{\sum_{i=1}^{N}Z_{i}} \sum_{i=1}^{N}Y_{i}Z_{i} - \frac{1}{1- \sum_{i=1}^{N}Z_{i}} \sum_{i=1}^{N}Y_{i}(1- Z_{i})
$$

実際には100の効果しかないデータで300の効果があるという分析結果が得られるのはなぜか？グループ間の比較が母集団の何を推定しているか？
これはセレクションバイアルの分が本当の効果(100)に加算されているためである

注意：分析のバイアスがサンプルサイズが大きくなることによって解決されるという謎の議論が行われることがある


#### RCTが最も信頼のおける分析方法である理由
RCTが割り当てをランダムに行う。つまりは$Z_{i}$がランダムに決定されるので、潜在的な傾向が偏りにくい
ただし、これはサンプルサイズが十分に大きくないといけない。サンプルサイズによってそのサンプルグループのセ潜在的傾向の平均が偏る確率が小さくなる。
つまりは潜在的な傾向の期待値は介入の有無のグループで同一になるため、セレクションバイアスが0になることが期待できる。

##### 十分大きいとはどれくらい大きいのか? -> 有意差を算出できる程度のデータサイズとはどれくらいかは物によるけどこれ自体の算出が必要

#### 有意差検定

- 中心極限定理：手元に得られたデータにおける平均の分布は元々のデータがどんな分布であれ正規分布で近似できる
- t検定：中心極限定理を元に、対象とする分布の平均値が他と異なるかどうかを推定する(ex 分布Aの平均値が0と異なるかどうか)


t検定のプロセス
- 1.標準誤差の算出
   - 標準誤差：大雑把に得られた推定結果が変動しそうな範囲を示す
- 2.効果の推定値と標準誤差を使ってt値を算出
   - t値：グループ間の平均の差を標準誤差で割ることで、標準誤差の何倍あるかを算出したもの
- 3.t値を使ってp値を算出
   - p値：得られた推定結果の効果が0であるにもかかわらず得られてしまう確率
- 4.p値を有意水準と比較する
   - 有意水準：経験的に設定した水準よりもp値よりも低い場合には「本来の期待値は0である状態」から得られた可能性は十分に低いと結論づける


#### ビジネスにおける因果推論の必要性
- RCTの実行にはコストがかかる
   - 分析の上では良いがビジネス上大きなコストになる実験である
   - 倫理的観点や信用リスクから現実として不可能
- セレクションバイアスは不可避
    - 実験担当が利得を高めようと選択した結果現れる
- ビジネスにおけるバイアスのループ
    - PDCAを回すごとにバイアスが堆積する


# 参考文献
- [期待値の性質](https://k-san.link/linearity-of-expectation/)
- [分散 avrien](https://ai-trend.jp/basic-study/basic/variance/)

</details>