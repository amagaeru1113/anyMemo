# 効果検証入門メモ

サンプルコード
https://github.com/ghmagazine/cibook/

# 効果検証入門



## 1章：セレクションバイアスとRCT

<details>
<summary>memo</summary>

- 効果：施策（介入、処置）以外の要因が同一となった状況での比較によって知り得た施策の影響度合い
- RCT(ABテスト含む)：グループの平均的な性質が同質なグループを介入の有無で分け、これらに施策が与えた影響を比較する試験
- 母集団：潜在的に観測し得る全てのデータを含む集団。
- 標本集団：母集団からいくらかの標本を抽出してなる集団
- 推定：標本集団から母集団の性質を推測すること

#### ポテンシャルアウトカムフレームワーク
ユーザーを$i$、介入の有無を01とし、$Z_{i}$で表す。つまりはユーザー1に介入する場合$Z_{1}=1$。
このユーザの売り上げを$Y_{i}$で表す。つまりはユーザー1に介入があった場合$Y_{i}^{(1)}(Z_{i}=1)$。
これは介入の有無でとる値が二値なので以下のように一つの式に整理できる。

$$
Y_{i} = Y_{i}^{(0)}(1-Z_{i}) + Y_{i}^{(1)}Z_{i}
$$

この単一のサンプル$i$に介入が行われた場合の売り上げと行われなかった場合の売り上げの差に介入の本当の効果があると考えることをポテンシャルアウトカムフレームワークという。ポテンシャルアウトカムとはつまりは反実仮想のことをさす。AとBの選択肢があるとき、私はAを選択してなんらかの結果を得た。この時のポテンシャルアウトカムはBを選択した時の結果のことをさす。売り上げならば介入した時の結果が$Y_{i}^{(1)}$ならば、ポテンシャルアウトカムは$Y_{i}^{(0)}$である。

介入の効果を表す値を$\tau$とすると、ユーザーiへの効果の度合いを売り上げの差分の形で表せる

$$
\tau_{i} = Y_{i}^{(1)} - Y_{i}^{(0)} 
$$

しかし実際にはこの計算式のどちらか一方の結果（売り上げ）しか常に手に入れられない。分かるのはユーザー$i$への介入の有無とその結果のみであって、ポテンシャルアウトカムは得られない。つまりはある個人に関する比較はできないことになる。

そこで、次に考えるのはユーザーのグループである。介入の有無でグループを作り、これらを比較することで「平均的な」効果を測る。
これは売り上げの期待値を比較し、差を得ることである。

$$
\tau = E[Y_{(1)}] - E[Y_{(0)}]
$$

E[]は期待値を表し、母集団における平均を表している。つまりは興味のある介入の効果とは、母集団に置いて介入の有無ぞれぞれの場合の売り上げの平均の差である。このような効果は母集団の平均的な効果を示し、平均処置効果（Average treatment Effect: ATE）と呼ばれる。

上記式を変形すると、介入がなかった場合の売り上げに平均処置効果の補正項を加えることで介入があった場合の売り上げを求める式に改変できる。

$$
E[Y_{(1)}]  =  E[Y_{(0)}] + \tau
$$

#### 平均的な効果の比較
実験をせず（ランダム化せず）に担当者が選んだユーザーグループに介入の有無を割り振る場合、最も簡単な効果の推定はk区グループのユーザー売り上げの平均を差分をとることである。ここでの効果の推定値を$\hat{\tau}_{naive}$と表す。分析するデータのサンプルサイズをNとすると、

$$
\hat{\tau}_{naive} = \frac{1}{\sum_{i=1}^{N}Z_{i}} \sum_{i=1}^{N}Y_{i}Z_{i} - \frac{1}{1- \sum_{i=1}^{N}Z_{i}} \sum_{i=1}^{N}Y_{i}(1- Z_{i})
$$

実際には100の効果しかないデータで300の効果があるという分析結果が得られるのはなぜか？グループ間の比較が母集団の何を推定しているか？
これはセレクションバイアルの分が本当の効果(100)に加算されているためである

注意：分析のバイアスがサンプルサイズが大きくなることによって解決されるという謎の議論が行われることがある


#### RCTが最も信頼のおける分析方法である理由
RCTが割り当てをランダムに行う。つまりは$Z_{i}$がランダムに決定されるので、潜在的な傾向が偏りにくい
ただし、これはサンプルサイズが十分に大きくないといけない。サンプルサイズによってそのサンプルグループのセ潜在的傾向の平均が偏る確率が小さくなる。
つまりは潜在的な傾向の期待値は介入の有無のグループで同一になるため、セレクションバイアスが0になることが期待できる。

##### 十分大きいとはどれくらい大きいのか? -> 有意差を算出できる程度のデータサイズとはどれくらいかは物によるけどこれ自体の算出が必要

#### 有意差検定

- 中心極限定理：手元に得られたデータにおける平均の分布は元々のデータがどんな分布であれ正規分布で近似できる
- t検定：中心極限定理を元に、対象とする分布の平均値が他と異なるかどうかを推定する(ex 分布Aの平均値が0と異なるかどうか)


t検定のプロセス
- 1.標準誤差の算出
   - 標準誤差：大雑把に得られた推定結果が変動しそうな範囲を示す
- 2.効果の推定値と標準誤差を使ってt値を算出
   - t値：グループ間の平均の差を標準誤差で割ることで、標準誤差の何倍あるかを算出したもの
- 3.t値を使ってp値を算出
   - p値：得られた推定結果の効果が0であるにもかかわらず得られてしまう確率
- 4.p値を有意水準と比較する
   - 有意水準：経験的に設定した水準よりもp値よりも低い場合には「本来の期待値は0である状態」から得られた可能性は十分に低いと結論づける


#### ビジネスにおける因果推論の必要性
- RCTの実行にはコストがかかる
   - 分析の上では良いがビジネス上大きなコストになる実験である
   - 倫理的観点や信用リスクから現実として不可能
- セレクションバイアスは不可避
    - 実験担当が利得を高めようと選択した結果現れる
- ビジネスにおけるバイアスのループ
    - PDCAを回すごとにバイアスが堆積する


# 参考文献
- [期待値の性質](https://k-san.link/linearity-of-expectation/)
- [分散 avrien](https://ai-trend.jp/basic-study/basic/variance/)

</details>

## 2章：介入効果を測るための回帰分析

<details>
<summary>memo</summary>

#### 回帰分析
##### 単回帰分析：変数が一つ
目的変数$Y$と入力となる変数$X$を用いて、$X$と$Y$の関係性を分析する。
この時、関係性に線形性を仮定する。すると一次式(傾きと切片)で関係を表せる。
ここで$u_{i}$は誤差項。

$$
Y_{i} = \beta_{0} + \beta_{1}X_{i}+u_{i}
$$

$\beta_{0},\beta_{1}$は真の値であるがこれはわからない。そこで手持ちのデータで得られる傾きと切片をそれぞれハットをつけて表し、これらを求めることとする。
$$
\hat{\beta_{0}}, \hat{\beta_{1}} = \argmin_{\beta_{0}, \beta_{1}} \sum_{i=1}^{N} (Y_{i} - \beta_{0} - \beta_{1}X_{i})^{2}
$$

上記は最小二乗法と呼ばれ、傾き・切片に関してそれぞれ微分することで極値を求めることができ、最適なパラメータの推定ができる。

推定は母集団上での回帰分析で得られるパラメータに対して行われている。

##### 効果分析のための回帰分析
介入の効果は施策を行った場合と行わなかった場合の結果の期待値の差分$\tau=E[Y^{(1)}] - E[Y^{(0)}]$で表される。

効果分析のための回帰分析では以下の変数を用いる。
- 被説明変数($Y$：dependent variable) 介入による効果を確認したい変数
- 説明変数　効果に影響する変数
    - 介入変数($Z$：treatment variable)　施策の有無を表す変数
    - 共変量($X$：controle variable) 介入・施策の有無で傾向が異なっていると想定される変数


共変量は複数である場合が多く。このように説明変数が複数ある回帰分析を重回帰分析という。
推定したいものはZ、Xを与えられた時のYの期待値であるので

$$
E[Y|X,Z] = \beta_{0} + \beta_{1}X+\beta_{2}Z
$$
重回帰分析も条件付き期待値と回帰分析の関係性が成立


$$
Y = E[Y|X,Z] + u = \beta_{0} + \beta_{1}X+\beta_{2}Z + u
$$

この時誤差項の条件付き期待値$E[u|X,Z]=0$であり、uとX及びZは相関しないという性質を持つ.
重回帰分析も単回帰分析と同じく、二乗誤差の最小化問題としてとく・

##### 回帰分析による効果の推定
- 介入結果の差分が効果の期待値 -> 施策の係数$\beta_{3}$


##### 回帰分析における有意差検定

- 推定値$\hat{\beta_{3}}$が母集団上の$\beta_{3}$が0である可能性
- を研修する->有意差検定

##### 効果検証のための回帰分析で行わないこと
- $\beta_{treatment}$が興味のある値->介入変数の係数
- 介入変数の係数以外の情報は無視する-> 分析の目的から逸れるから

#### 回帰分析におけるバイアス
##### 共変量の追加による効果への作用
- 共変量とセレクションバイアスの関係性
- セレクションバイアスが発生しているデータに置いて、共変量を加えて回帰分析を行うことで影響を低減できる

##### 脱落変数バイアス(OVB)
- 共変量の追加でセレクションバイアスの影響を低減 -> 「どのような共変量をモデルに追加するべきか？」 -> 「目的変数Yと介入変数Zに対して相関のある変数を加えるべき」
- 追加することによってセレクションバイアスの影響の小さい結果を得られる共変量だがモデルから抜け落ちている変数 -> 脱落変数
- 必要な共変量がモデルに含まれない場合、推定される効果にはO脱落変数バイアス(OVB)が含まれる
- 有意差検定の結果で介入変数以外の結果を考慮しようとするとOVBを発生させる可能性がある


##### OVBが与えてくれる情報
- OVBの式は共変量が不十分なモデルの持つバイアスの構造を表す
- 構造とは、バイアスの値 = 「脱落変数とZの関係」　× 「脱落変数と目的変数の関係」
- これよりモデルに加えるべき共変量はZとYに相関するような変数 -> **交絡因子**

##### Conditional Independence Assumption（CIA）
- 共変量の選択の理想：モデルに含まれていない変数によるOVBが全て0になる
- モデルに含めた共変量で条件付けた時に、介入変数が$Y^{(1)}$や$Y^{(1)}$と独立している状態になる -> CIA
- 解釈としてじゃ共変量が同一のサンプルにおいて、介入Zはランダムに割り振られているのと同じになる
    - 年齢、性別、過去の購買額が同じ値のユーザーに施策を割り振る時、割り振りかたはサイコロを振るのと同じになる -> 割り振る人のバイアスがなくなる？


##### 変数の選び方とモデルの評価
問題
- バイアスの評価ができない -> 得られた効果の推定値がどの程度バイアスを含むか評価不能。OVBは相対的な数値なのでバイアスの大きさは示さない。
- 必要な共変量がデータにはない

上記二つの問題点は明確な指標を見ながらモデルの選択ができす、モデルの限界についても定量的に評価できないことを意味する。
これについては分析者の経験的な判断が求められる。またはより応用的な手法で対応する。

##### Sensitivity Analysis
- 回帰分析はセレクションバイアスを起こす変数をモデルに組み込むことで、その問題を軽減する方法
- データに含まれない変数がセレクションバイアスを起こす場合に対応不可能 -> 低減に使得ないから
- データに含まれない変数がセレクションバイアスを起こしているかは評価できる -> Sensitivity Analysis

Sensitivity Analisysとは、重要だと分析者が認識している共変量以外の共変量をモデルから除外することで、効果の推定値が大きく変動しないか確認するという分析です。

##### Post treatment bias
- セレクションバイアスが減る可能性がある、OVBの値が0でない変数を全てモデルに入れていいわけではない
- 因果的に介入の影響を受けた変数を分析にいれることによって起きるバイアス -> Post Treatment Bias
    - 例）サイト来訪者数の比較　メールを配信したグループ(元々サイト来訪するユーザ、メールが来たからサイト来訪したユーザ)　> メールが配信されなかったグループ（元々サイト来訪するユーザ）
    - 上の例でグループの売り上げ平均を見ると、明らかに配信されなかったグループが低くなる
- 介入よりもあとのタイミングで値が決まるような変数は分析から除外する


#### 回帰分析を利用した探索的な効果検証
Angrist et al(2002)はコロンビアで行われた私立学校の学費の割引に関する実験を分析した研究である。

##### PACESによろう学費の割引券配布の概要
- 教育に対する補助のあり方に関する議論
- 教育の提供側である学校に補助するか、受給側である生徒に補助するか
- 学費の半額を政府が肩代わりするという介入
- RCTではなく回帰分析 -> 調査の回答を得られる可能性が介入の有無によって変動するから

##### 乳立学校への通学と割引券の利用についての分析
- 当選グループにおいて私立学校で6年生を始める比率が6%高まった -> 当落に関係なく私立学校へ通う生徒が多い
-  そうせんグループにおいて何かしらの奨学金を調査期間中に使っている割合が非当選グループより高い

#### 回帰分析に関する様々な議論
##### 予測と効果推定
- モデルのデータに対する説明能力や未知のサンプルに対する予測能力を高めることが”効果検証において有用である”という保証にはならない

##### 制限被説明変数（Limited Dependent Variable）
- 予測や説明力を重視するようなモデルを扱う分野において、Yの分布に対してより適したモデルを選択されやすい
    - Yが購入したか否かのような二値 -> ロジスティック回帰
    - Yが売り上げのような0以上の整数値 -> ポアソン回帰
- 制限被説明変数：目的変数が特定の値しか撮らないような制約がある状態の変数
- 本書では介入変数が二値で線形回帰が行えるが、例えばZとYの関係が非線形であるなどしたら線形回帰の妥当性はない

##### 対数を利用した回帰分析
- 変数の自然対数をとった値をY、Xで利用することがある
- 目的変数の対数をとる場合の解釈 -> 推定されるパラメータはYに対して何%の影響があったか？
- 説明変数の対数をとる場合の解釈 -> 推定されたパラメータはXを1%変化させた時にYに対してどの程度の影響を与えるか？
- 使い所
    - 目的変数に対する介入の効果が比率で扱われるべきである場合
    - 共変量と目的変数の関係が比率で扱われるべきである場合

##### 多重共線性
- 多重共線性とは、回帰モデルに含まれている変数のうち二つが強い相関を持つ状況をさす。
- この場合、推定されるパラメータの標準誤差が変化してしまうため、検定の結果が歪む。
- 一番の問題は、推定されたおパラメータの標準誤差が信頼できない物になる点

</details>


## 3章：傾向スコアを用いた分析

<details>
<summary>memo</summary>


#### 傾向スコアの仕組み
##### 傾向スコアのアイデア

- 回帰分析は共変量の選定が重要
- しかし目的変数Yについての情報が十分に得られない場合がある
    - 目的変数に影響する変数が不明瞭 -> モデル化が難しい
    - 手元にあるデータが高次元（数千〜数万の変数）　-> 選定に時間がかかる 
- 傾向スコア：各サンプルにおいて介入が行われる確率
    - 着眼点：介入が行われた仕組みの解明
    - 目的：共変量の調整
    - 方法：介入グループと非介入グループの性質を均一にする操作を行う
- CIA（COnditional Independence Assumption）に近い
    - 共変量が同一のユーザの中では介入の決定はランダムに行われているに等しい
    - 傾向スコアが同一のユーザの(ry

傾向スコア$P(X_{i}$の仮定
$$
{Y_{i}^{(1)}, Y_{i}^{(0)}} \perp Z|P(X_{i})
$$

##### 傾向スコアの推定
- 傾向スコアを直接観測はできないが、結果であるZは観測可能
- 手持ちのデータから傾向スコアを推定する：ロジスティック回帰が多い
- ロジスティック回帰で得られた結果で重要なのは予測値
    - 推定されたパラメータの値が直感に息しているかの解釈は質の保証にならない
    - 傾向スコアの推定を行ったモデルに関しては特に解釈を行う必要はない

#### 傾向スコアを利用した効果の推定
##### 傾向スコアマッチング
介入変数Zの効果を推定する方法で今回紹介するのは以下二つ
- 傾向スコアマッチング：得られた傾向スコアを利用してサンプルどうしをマッチングさせる
- 逆確率重み付き推定：傾向スコアをサンプルの重みとして利用する

傾向スコアマッチングのアイデア
- 介入グループから取り出したサンプルの傾向スコアに近いものを、非介入グループからマッチングしてペアにする。
- ペアの中で目的変数の差を算出し、サンプルの数を重みとした重み付きの平均を推定値とする。
- ペアにする理由は傾向スコアが同じ物は介入がランダムに決定されているとみなせるから。
- つまりはセレクションバイアスの影響を受けない。

Average Treatment effect on Treated(ATT)
介入を受けたサンプルにおける介入効果の期待値
$$
\hat{\tau}_{match} = E{E[Y|P(X), Z=1] - E[Y|P(X), Z=-} | Z=1}
$$

問題点
- 計算時間が長い
- 変数が多くなると、傾向スコアが”同じ”という物は減っていくので”同じ”の判定方法を考える必要がある


##### 逆確率重み月推定
IPWのアイデア
- 傾向スコアをサンプルの重みとして利用して、与えられたデータ全体での介入の結果の期待値と非介入の結果の期待値の差分をとることで効果を推定
- IPWのセレクションバイアス：$P(X)$の偏りによって介入グループ自体に偏りが生じる
- 仮定：傾向スコアと介入の結果に正の相関がある -> この過程の妥当性は？
- この場合、$Y~{(1)}$が小さいデータほどZ-1のデータには含まれない -> 期待値が過剰に評価されて、推定される効果も過剰になる

IPWでは介入の結果の平均を次のように考える
$$
\bar{Y^{(1)}} = \sum_{i=1}^{N} \frac{Z_{i}Y_{i}}{\hat{P(X_{i})}} / \frac{Z_{i}}{\hat{P(X_{i})}}
$$

傾向スコアが大きくなるほど、傾向スコアの逆数が大きくなるため、サンプルに含まれないぶん重みを増加する。

やっていることは縦軸に介入の結果、横軸に傾向スコアをおいた分布を母集団の分布に近づけようとしている。

非介入の結果の推定は確率に$1-\hat{p(X_{i})}を使って行う。
$$
\bar{Y^{(0)}} = \sum_{i=1}^{N} \frac{(1-Z_{i})Y_{i}}{1- \hat{P(X_{i})}} / \frac{(1- Z_{i})}{1- \hat{P(X_{i})}}
$$

これらよりIPWを用いた効果の推定値は
$$
\hat{\tau_{IPW}} = \bar{Y^{(1)}} - \bar{Y^{(0)}} 
$$

#### より良い傾向スコアとは
- 傾向スコアはデータに対する説明力が一定を超えることが重要だと解釈される
- これはc統計量のような指標が基準を上回ることが望ましい（c統計量：大雑把にいうとROC曲線の下側の面積 医療統計で使われ、c>0.8なら良い多分経験的)
- 近年、傾向スコアを用いてマッチングや重みづけしたあとのデータで、共変量のバランスが取れているかが重要というのが一般的
- 標準化平均差（Average Standardized  Avsolute Mean distance：ASAM）
    - 平均の差をその標準誤差で割った物
    - ASAMが0.1以下がバランスが取れていると考えられる

##### 傾向スコアと回帰分析の比較
介入の効果の分析において、共変量の影響を取り除く点で両者はほぼ同じ。そこでどちらを使うべきかの話になる。

回帰分析
- 取り組みやすい
- 目的変数と共変量の関係についてのモデリングが必要
- いれるべき共変量をもでrに設定できないとOVBの影響が生じる
- OVBの評価やSensitivity Analysisなどの分析上のツールがある

傾向スコア
- 目的変数に対するモデリングを行わなくて済む
- Zの決定方法に関する調査で有益な情報を得られる
- 計算時間がかかるために大量の分析を行うことに向いていない

Yの値がどんな仕組みで決定されるかの情報が豊富な場合-> 回帰分析 not -> 傾向スコア
 
 ###### マッチングとIPWの差
 マッチング、IPW、回帰分析の結果はまず一致しない -> 推定しているものが異なる
 
-  マッチング：ペアが作れるデータ、つまりZ-1となるようなサンプルにおける平均的な効果を推定
-  IPW：得られたデータ全てに対して期待値を推定するので、Zに関わらず、全てのデータでの平均的な効果を推定

ビジネスの結果が実験と近いものであることを示す必要がある場合、実験のサンプルがどのような物かは注意が必要
 
 
#### LaLondeデータセットの分析
RCTの結果が本来は最も信頼できる分析であるが、それができないような状況で、信頼できる分析結果をたいというんが因果推論のモチベーション。
-> RCTによる実験結果を因果推論の方法で再現できるのか？(LaLonde)

NSW：労働市場へ参加できないような人々にカウンセリングと)~19ヶ月の短期的な就労経験を与えることを就職を助ける試みで、希望者からランダムに選択した人に対して介入を行った。肝は非介入グループを削除し、実験の外で得られたCPSという調査データを代わりに挿入してデータセットを作成し、これを持ってRCTの分析結果を擬似的に獲得した。
これを使ってRCTの分析を起こないNSWの結果と比較を行った。

- 回帰分析：NSWの実験で得られた結果とは大きく異なった。
- 傾向スコアマッチング：NSWの結果に近い結果を推定できた。


注意点
自分が分析するデータがどのようなデータであり、推定したい効果がどのようなサンプルにおける効果なのかに十分に配慮しなければならない。これが守られなければ、どのモデルの結果がより信頼たりえるかを判断することが非常に難しい。

</details>