## SQL基礎

### select文

- 基本は`select 列1, 列2, ... from Table名;`
- 全ての列を取得したい場合は*で指定

よくあるミス
- DBを洗濯していない
- スペルミス（DB名、テーブル名、カラム名）
- 全角文字で入力する

書き方の補足
- 空白をいくつ足しても実行可能
- 改行しても良い
- みやすさのために改行とインデントを使うことがある
- 構文を大文字にして、テーブル名やカラム名は小文字にすることもある

### 比較演算子
https://www.dbonline.jp/mysql/ini/index7.html

### 集約関数
- sum(expr): 合計値
- avg(expr): 平均値
- min(expr): 最小値
- max(expr): 最大値
- count(expr): 行数

上記を利用したデータ集計の例
- 月別売り上げ
- 商品価格の最大値、最小値、平均値
- テーブル行数の取得
- 月別アクセス数
- 月別ユニークユーザー数
- 月別ユニークユーザー数がn人以上の月を抽出
- 都道府県別のユーザー数

### 集約関数におけるnullの扱い
- null: 値がないことを示す
- 集約関数ではnullが無視される
- DBにnullが含まれないように数値:0や文字列:''で代替できないか検討してみる

### SQLの記述順序
1. select       : 取得列の指定
2. from         : 対象テーブルの指定
3. join         : 結合処理
4. where        : 絞り込み条件の指定
5. group by     : グループ化の条件指定
6. having       : グループ化後の絞り込みの条件指定
7. order by     : 並び替え条件を指定
8. limit        : 取得行数の制限

### SQLの実行順序
1. from         : 対象テーブルの指定
2. join         : 結合処理
3. where        : 絞り込み条件の指定
4. group by     : グループ化の条件指定
5. having       : グループ化後の絞り込みの条件指定
6. select       : 取得列の指定
7. order by     : 並び替え条件を指定
8. limit        : 取得行数の制限


### 並び替え
- order by: ascは昇順（小->大）、descは降順（大->小）
- 並び順を指定しないと将来的にどんな順番で表示されるかわからない
- 複数条件で並び替えしたい時はorder byに併記
- 商品名で並び替えたい時、アルファベットならアルファベット順になる
- 日本語の場合は文字コード順になる

### 算術演算子
https://www.dbonline.jp/mysql/ini/index6.html

- nullを含んだ計算の結果はnullになる


---

## テーブルの結合
ref
- https://oss-db.jp/dojo/dojo_info_04

### テーブルの正規化
正規化とは、データの重複をなくし整合的にデータを取り扱えるようにデータベースを設計することである。
このsample DBではusersのprefecture_id（都道府県）をテーブルprefecturesと関連づけることである。
これにより、都道府県はprefecturesの中で一つずつ格納されるだけになる。
仮にこの情報をusersで持つと、都道府県の重複が膨大になってしまう。

### 主キーと外部キー
- 主キー（primary key）:一つの行と特定できる列のこと(usersテーブルであればid、prefecturesテーブルであればid)
- 外部キー（Foreign Key）: 他のテーブルとの関連づけに使う列のことであり、関連づけされた先のテーブルでは主キーになる。（users.prefecture_id = prefectures.id）

### リレーションシップの種類
言い換えると、テーブル同士の結びつき・関係性の種類のことである。
種類とその例について以下にあげる。
- 1対多
    - ユーザー：注文
    - ブログ投稿者：ブログ記事
    - 部署：所属者
- 多対多
    - 商品：商品カテゴリ
    - ブログ記事：ブログカテゴリ
    - ユーザー：操作権限
- 1対1(特殊なので余り使わないが、機密情報を切り離したい時に使う)
    - 電話番号id:電話番号



多対多を表現する際、キーをつなげるための中間テーブルがある。
　
### 内部結合
内部結合とは2つのテーブルでそれぞれ結合の対象となるカラムを指定し、それぞれのカラムに同じ値が格納されているデータを結合して取得するもの。

### 外部結合
外部結合とは2つのテーブルでそれぞれ結合の対象となるカラムを指定し、それぞれのカラムに同じ値が格納されているデータを結合して取得するもの。内部結合の場合は、一致しないデータは取得しませんでしたが、外部結合の場合は一致しない場合もデータとして取得します。

欠落のあるデータにしたいして行う結合である。
また外部結合には二種類ある。
- 左外部結合：左側（from句で最初に書いたテーブル）をマスタとする
- 右外部結合：右側（from句で後に書いたテーブル）をマスタとする

### union
テーブルの和を求める際にはunionを使用する。
注意点として、unionを行うテーブル同士の列数とデータ型を一致させる必要がある。

---

## ビュ- 
- テーブルは実際のデータを保存するが、ビューにはselect文は保存されておりデータは持たない
- 正し制限があり、order by句が使えない
- またパフォーマンス低下することがある

### ビューの作成と利用、及び削除

作成
```
create view ビュー名（列名1 ,列名2,...）as select文
```

利用
```
select
    列名1,
    列名2,
    ...
from
    ビュー名
```

削除
```
drop view ビュー名;
```
---

## サブクエリ
参考：https://qiita.com/aki3061/items/6df0513ccc5aa40a075a

サブクエリとは大雑把には、ある問合せに基づいて、異なる問合せを行う仕組みをさす。
これを使うことによって複雑な処理が行える。例として以下にあげる。

- 全商品の平均単価より、高い商品を取得
- 商品別の平均販売数量よりも多く売れている日を取得
- 商品カテゴリごとに平均単価を取得

### 構文
```
select
    列名, ...
from
    テーブル名
where
    列名 演算子（select 列名, ... from テーブル名2）
```

---

## 条件分岐case
 
 case式を使うと、SQLで条件分岐を記述できる.
 
 
### 構文
```
case
    when 条件式1 then 値1
    ...
end
```

---

## データの更新

### 新規データを追加するinsert

データベースのテーブルに新規データ（行）を追加する

#### 構文
列を指定する場合
```
insert into
    テーブル名（列1,列2, ...）
values
    (値1, 値2, ...)
```


列を指定しない場合は全列の要素を指定する必要がある
```
insert
    テーブル名
values
    (値1, 値2, ...)
```

### レコードの更新update
データベースのテーブルの値を更新する

#### 構文

```
update テーブル名 set 列1 = 値1, [列2 = 値2, ...]
[where 条件式]
```

### レコードの削除delete
データベースのテーブルの値を削除する

#### 構文

```
delete from テーブル名 [where 条件式]
```

## データベース構造の操作

### データベースの確認
```
show databases;
```

### データベースの追加
```
create database DB名
```

### テーブルの追加

例としてbooksというテーブルを追加する
```
create table books(id int not null auto_increment primary key,
				   title varchar(255) not null)
```

- int: 整数型
- not null: nullを許可しない
- auto_increment: idを自動で割り振る
- primary key: 主キーの設定
- varhar(255): 最大255文字の可変長文字列型